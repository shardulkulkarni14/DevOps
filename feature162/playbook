- hosts: node1.local
  become: true
  become_method: sudo
  tasks:
    - name: nginx installation for node1
      apt:
        name: nginx
        state: present
        update_cache: true
        cache_valid_time: 5000

    - name: Configure nginx as load balancer
      blockinfile:
        dest: /etc/nginx/nginx.conf
        insertafter: "http {"
        content: |
          upstream backend {
              server node2.local:80 weight=5;
              server node3.local:8080 weight=1;
          }
          server {
              listen 80;
              server_name node1.local;
              
              location / {
                proxy_pass http://backend;
              }
          }

    - name: Start the nginx server 
      service:
        name: nginx
        state: started



- hosts: node2.local
  become: true
  become_method: sudo
  vars_files:
    - default.yml
  tasks:
    - name: Install Apache
      apt:
        name: apache2
        state: present
        update_cache: yes

    - name: Create document root
      file:
        path: "/var/www/{{ http_host }}"
        state: directory
        owner: "{{ app_user }}"
        mode: '0755'

    - name: Copy index test page
      template:
        src: "index.html.j2"
        dest: "/var/www/{{ http_host }}/index.html"

    - name: Set up Apache virtual host
      template:
        src: "apache.conf.j2"
        dest: "/etc/apache2/sites-available/{{ http_conf }}"

    - name: Enable new site
      command: /usr/sbin/a2ensite {{ http_conf }}
      notify: restart apache2
      
    - name: Disable default Apache site
      command: /usr/sbin/a2dissite 000-default.conf
      when: true

  handlers:
    - name: restart apache2
      service:
        name: apache2
        state: restarted

- hosts: node3.local
  become: true
  become_method: sudo

  tasks:
    - name: Update the System Packages
      apt:
        upgrade: yes
        update_cache: yes
    - name: Install jdk
      apt:
        name: default-jdk
        state: present

    - name: setup version 9.0.37 of Tomcat
      get_url:
        url: https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.37/bin/apache-tomcat-9.0.37.tar.gz
        dest: /usr/local

    - name: Extract the gz file
      ansible.builtin.unarchive:
        src: /usr/local/apache-tomcat-9.0.37.tar.gz
        dest: /usr/local
        remote_src: yes

    - name: Web server home page Configuration
      copy:
        dest: /usr/local/apache-tomcat-9.0.37/webapps/ROOT/index.html
        content: |
          <!DOCTYPE html>
          <html lang="en">
          <head>
          <title>node3.local tomcat server</title>
          </head>
          <body>
          <p>qhrykxeislbu</p>
          </body>
          </html>

    - name: Starting Tomcat Server
      shell: nohup /usr/local/apache-tomcat-9.0.37/bin/startup.sh
